name: joplin-desktop
base: core22
summary: A free, private note taking and to-do app!
description: |
  Joplin is an open source, free note taking application. Designed to be capable of replacing Evernote, Joplin is privacy conscious and can be be used without signing up for an account, but optionally supports synchronising your files with a file host of your choice and with optional end to end encryption.

  Developer site: https://joplinapp.org/

  Snap build: https://github.com/MrCarroll/joplin-snap
grade: stable
confinement: strict
license: AGPL-3.0-or-later
adopt-info: joplin
compression: lzo

parts:
  joplin:
    plugin: nil
    source: https://github.com/laurent22/joplin.git
    source-commit: 708104661d9f47480abe6daad3bcf6aa0ba56b3b # 2.12.19
    build-environment:
      -  SUDO_UID: 0
      -  SUDO_GID: 0
      -  SUDO_USER: root
      -  npm_config_prefer_offline: true
    build-packages:
      - build-essential
      - python2
      - rsync
      - libsecret-1-dev
      - curl
    build-snaps:
      - node/16/stable
    stage-packages:
      - libnotify-bin
    override-pull: |
      craftctl default
      craftctl set version=$(git describe --tags)
      for file in ${CRAFT_PROJECT_DIR}/snap/local/patches/*.patch
      do
        patch -i $file -p 1
      done
    override-build: |
      ln -s /usr/bin/python2 /usr/bin/python
      unset PYTHONPATH
      yarn install
      cd ${CRAFT_PART_BUILD}/packages/app-desktop
      yarn run dist
      mkdir ${CRAFT_PART_INSTALL}/opt -p
      cp -r dist/*unpacked ${CRAFT_PART_INSTALL}/opt/joplin-desktop
      mv ${CRAFT_PART_INSTALL}/opt/joplin-desktop/@joplinapp-desktop ${CRAFT_PART_INSTALL}/opt/joplin-desktop/joplin

  xdg-open:
    plugin: go
    source-type: local
    source: ./xdg-open
    build-snaps:
      - go
    organize:
      bin/dbus: bin/xdg-open
  cleanup:
    plugin: nil
    build-snaps:
      - core22
      - gnome-42-2204
    override-prime: |
      set -eux
      for snap in "core22" "gnome-42-2204"; do
          cd "/snap/$snap/current" && find . -type f,l -exec rm -f "$SNAPCRAFT_PRIME/{}" \;
      done
    after: [joplin, xdg-open]

plugs:
  private-shmem:
    interface: shared-memory
    private: true
  network:
  browser-support:
  opengl:
  desktop:
  desktop-legacy:
  unity7:
  wayland:
  x11:
  home:
  removable-media:
  password-manager-service:
  audio-playback:
  cups:

apps:
  joplin-desktop:
    command: opt/joplin-desktop/joplin --no-sandbox
    extensions: [gnome]
    environment:
      TMPDIR: ${XDG_RUNTIME_DIR}
      PATH: ${SNAP}/bin:${PATH}
